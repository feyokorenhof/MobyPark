name: MobyPark CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Tests
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v5

      - name: Build and start services
        run: |
          docker compose up -d --build

      - name: Run tests
        run: |
          docker compose exec -T api pytest

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans

  deploy:
    name: Deploy (push to main only)
    needs: test
    runs-on: self-hosted
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy over SSH
        env:
          SSH_HOST: ${{ secrets.PROD_HOST }}
          SSH_USER: ${{ secrets.PROD_USER }}
          SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
        run: |
          set -euo pipefail

          install -m 700 -d ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" 'bash -s' <<'EOF'
            set -euo pipefail

            cd /opt/mobypark
            git fetch origin main
            git reset --hard origin/main

            docker compose up -d --build
            docker compose exec -T api alembic upgrade head

            curl -fsS http://127.0.0.1:8000/health >/dev/null
            echo "Deploy OK"
          EOF
