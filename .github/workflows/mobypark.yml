name: MobyPark CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: self-hosted
    strategy:
      matrix:
        python-version: ["3.13"]

    # Shared env for CI
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_TEST_DB: ${{ secrets.POSTGRES_TEST_DB }}
      APP_HOST: ${{ secrets.APP_HOST }}
      APP_PORT: ${{ secrets.APP_PORT }}
      APP_WORKERS: ${{ secrets.APP_WORKERS }}

    steps:
      - uses: actions/checkout@v5

      - name: Wait for Docker daemon
        run: |
          for i in $(seq 1 90); do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi

            if [ $((i % 10)) -eq 0 ]; then
              echo "---- docker debug at ${i}s ----"
              docker version || true
              ls -l /var/run/docker.sock /run/docker.sock 2>/dev/null || true
              df -h || true
            fi

            sleep 1
          done

          echo "Docker daemon did not become ready in time"
          exit 1

        # Aggressive pre-clean for 20GB VM limit :o
      - name: Pre-clean Docker
        run: |
          docker compose down -v --remove-orphans || true
          docker system prune -af --volumes || true

      - name: Create .env for docker compose
        run: |
          cat > .env << EOF
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_TEST_DB=${{ secrets.POSTGRES_TEST_DB }}
          APP_HOST=${{ secrets.APP_HOST }}
          APP_PORT=${{ secrets.APP_PORT }}
          APP_WORKERS=${{ secrets.APP_WORKERS }}
          DATABASE_HOST=db
          DATABASE_PORT=5432
          DATABASE_NAME=${{ secrets.POSTGRES_DB }}
          DATABASE_USER=${{ secrets.POSTGRES_USER }}
          DATABASE_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DATABASE_URL=postgresql+psycopg://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}
          DATABASE_URL_TEST=postgresql+psycopg://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_TEST_DB }}
          pid=
          exists=
          EOF

      - name: Pull images (best-effort)
        run: docker compose pull --quiet || true

      - name: Spin up docker
        run: docker compose up -d --no-build --remove-orphans

      - name: Wait for Postgres to be ready
        run: |
          CONTAINER_ID=$(docker compose ps -q db)
          for i in {1..30}; do
            if docker exec "$CONTAINER_ID" pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"; then
              echo "Postgres is up"
              exit 0
            fi
            echo "Postgres not ready yet... ($i/30)"
            sleep 1
          done
          echo "Postgres did not become ready in time"
          docker compose logs db || true
          exit 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest --doctest-modules \
            --junitxml=junit/test-results.xml \
            --cov=com --cov-report=xml

      # Always clean up CI containers/images/volumes
      - name: Cleanup Docker (always)
        if: always()
        run: |
          docker compose down -v --remove-orphans || true
          docker system prune -af --volumes || true

  deploy:
    name: Deploy (main only)
    needs: test
    runs-on: self-hosted

    # Only deploy on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy over SSH
        env:
          SSH_HOST: ${{ secrets.PROD_HOST }}
          SSH_USER: ${{ secrets.PROD_USER }}
          SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
        run: |
          set -euo pipefail

          install -m 700 -d ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" 'bash -s' <<'EOF'
            set -euo pipefail

            cd /opt/mobypark

            # Update code
            git fetch origin main
            git reset --hard origin/main

            # Start/refresh services
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.prod up -d --build

            # Run migrations
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.prod exec -T api alembic upgrade head

            # Health check
            curl -fsS http://127.0.0.1:8000/health >/dev/null
            echo "Deploy OK"
          EOF
