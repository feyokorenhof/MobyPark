name: MobyPark
on: [push, pull_request]
jobs:
  build:
    runs-on: self-hosted
    environment:
      name: testing
    strategy:
      matrix:
        python-version: ["3.13"]
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_TEST_DB: ${{ secrets.POSTGRES_TEST_DB }}
      APP_HOST: ${{ secrets.APP_HOST }}
      APP_PORT: ${{ secrets.APP_PORT }}
      APP_WORKERS: ${{ secrets.APP_WORKERS }}
    steps:
      - uses: actions/checkout@v5
      - name: Create .env for docker compose
        run: |
          cat > .env << EOF
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_TEST_DB=${{ secrets.POSTGRES_TEST_DB }}
          APP_HOST=${{ secrets.APP_HOST }}
          APP_PORT=${{ secrets.APP_PORT }}
          APP_WORKERS=${{ secrets.APP_WORKERS }}
          DATABASE_HOST=db
          DATABASE_PORT=5432
          DATABASE_NAME=${{ secrets.POSTGRES_DB }}
          DATABASE_USER=${{ secrets.POSTGRES_USER }}
          DATABASE_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DATABASE_URL=postgresql+psycopg://$DATABASE_USER:$DATABASE_PASSWORD@$DATABASE_HOST:$DATABASE_PORT/$DATABASE_NAME
          DATABASE_URL_TEST=postgresql+psycopg://$DATABASE_USER:$DATABASE_PASSWORD@$DATABASE_HOST:$DATABASE_PORT/$POSTGRES_TEST_DB
          EOF
      - name: Spin up docker
        run: docker compose up -d
      - name: Wait for Postgres to be ready
        run: |
          CONTAINER_ID=$(docker compose ps -q db)
          for i in {1..20}; do
            if docker exec "$CONTAINER_ID" pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"; then
              echo "Postgres is up âœ…"
              break
            fi
            echo "Postgres not ready yet... ($i/20)"
            sleep 1
          done
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Test with pytest
        run: |
          pip install pytest pytest-cov
          pytest --doctest-modules --junitxml=junit/test-results.xml --cov=com --cov-report=xml --cov-report=html
      - name: Cleanup Docker (always)
        if: always()
        run: |
          docker system prune -af --volumes
